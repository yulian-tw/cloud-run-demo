name: Deploy json-server

on:
  push:
    branches:
      - main
    paths:
      - api/**
      - Dockerfiles/Dockerfile.backend
      - .github/workflows/json-server.yml

env:
  CONTAINER_REGISTRY_HOSTNAME: asia.gcr.io

jobs:
  deploy-json-server:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: asia.gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend:latest
      FRONTEND_URL: ""
    steps:
      - name: Checkout ðŸ›Ž
        uses: actions/checkout@v3
      - name: GCP Auth
        uses: "google-github-actions/auth@v0"
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"
      - name: Configure Docker
        run: gcloud auth configure-docker --quiet $CONTAINER_REGISTRY_HOSTNAME
      - name: Build Docker image
        run: docker build -f Dockerfiles/Dockerfile.backend . -t $IMAGE_NAME
      - name: Push Docker image
        run: docker push $IMAGE_NAME
  #     - name: Deploy Docker image
  #       run: |
  #         gcloud run deploy backend --image $IMAGE_NAME --region asia-southeast1 --platform managed \
  #           --set-env-vars=API_SECRET=${{ secrets.API_SECRET }},FRONTEND_URL=$FRONTEND_URL \
  #           --memory 128Mi --allow-unauthenticated
